version: "3.8"

services:
  # =============================================================================
  # DATABASE SERVICE
  # =============================================================================
  playlizt-database:
    image: postgres:17
    container_name: playlizt-database
    environment:
      POSTGRES_DB: ${PLAYLIZT_DB_NAME}
      POSTGRES_USER: ${PLAYLIZT_DB_USER}
      POSTGRES_PASSWORD: ${PLAYLIZT_DB_PASSWORD}
      TZ: ${TZ}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "${PLAYLIZT_DB_PORT}:${PLAYLIZT_DB_PORT}"
    networks:
      - playlizt-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${PLAYLIZT_DB_USER} -d ${PLAYLIZT_DB_NAME}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  # =============================================================================
  # REDIS CACHE
  # =============================================================================
  redis:
    image: redis:alpine
    container_name: playlizt-redis
    ports:
      - "6379:6379"
    networks:
      - playlizt-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  # =============================================================================
  # EUREKA SERVICE DISCOVERY
  # =============================================================================
  playlizt-eureka-service:
    build:
      context: .
      dockerfile: playlizt-eureka-service/Dockerfile
      args:
        PLAYLIZT_UID: ${PLAYLIZT_UID}
        PLAYLIZT_GID: ${PLAYLIZT_GID}
        SERVER_PORT: ${PLAYLIZT_EUREKA_PORT}
    container_name: playlizt-eureka-service
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE}
      - SERVER_PORT=${PLAYLIZT_EUREKA_PORT}
      - JAVA_OPTS=${JAVA_OPTS}
      - TZ=${TZ}
    ports:
      - "${PLAYLIZT_EUREKA_PORT}:${PLAYLIZT_EUREKA_PORT}"
    volumes:
      - ${PLAYLIZT_LOG_PATH}/eureka:/var/log/playlizt
    networks:
      - playlizt-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${PLAYLIZT_EUREKA_PORT}/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    depends_on:
      playlizt-database:
        condition: service_healthy

  # =============================================================================
  # AUTH SERVICE
  # =============================================================================
  playlizt-authentication:
    build:
      context: .
      dockerfile: playlizt-authentication/Dockerfile
      args:
        PLAYLIZT_UID: ${PLAYLIZT_UID}
        PLAYLIZT_GID: ${PLAYLIZT_GID}
        SERVER_PORT: ${PLAYLIZT_AUTH_PORT}
    container_name: playlizt-authentication
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE}
      - SERVER_PORT=${PLAYLIZT_AUTH_PORT}
      - SPRING_DATASOURCE_URL=jdbc:postgresql://${PLAYLIZT_DB_HOST}:${PLAYLIZT_DB_PORT}/${PLAYLIZT_DB_NAME}
      - SPRING_DATASOURCE_USERNAME=${PLAYLIZT_DB_USER}
      - SPRING_DATASOURCE_PASSWORD=${PLAYLIZT_DB_PASSWORD}
      - SPRING_CLOUD_GCP_SQL_ENABLED=false
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=${PLAYLIZT_EUREKA_URL}
      - JWT_SECRET=${PLAYLIZT_JWT_SECRET}
      - JWT_EXPIRATION_MS=${PLAYLIZT_JWT_EXPIRATION_MS}
      - JWT_REFRESH_EXPIRATION_MS=${PLAYLIZT_JWT_REFRESH_EXPIRATION_MS}
      - JAVA_OPTS=${JAVA_OPTS}
      - TZ=${TZ}
    ports:
      - "${PLAYLIZT_AUTH_PORT}:${PLAYLIZT_AUTH_PORT}"
    volumes:
      - ${PLAYLIZT_LOG_PATH}/auth:/var/log/playlizt
    networks:
      - playlizt-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${PLAYLIZT_AUTH_PORT}/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    depends_on:
      playlizt-database:
        condition: service_healthy
      playlizt-eureka-service:
        condition: service_healthy

  # =============================================================================
  # CONTENT SERVICE
  # =============================================================================
  playlizt-content-api:
    build:
      context: .
      dockerfile: playlizt-content/playlizt-content-api/Dockerfile
      args:
        PLAYLIZT_UID: ${PLAYLIZT_UID}
        PLAYLIZT_GID: ${PLAYLIZT_GID}
        SERVER_PORT: ${PLAYLIZT_CONTENT_API_PORT}
    container_name: playlizt-content-api
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE}
      - SERVER_PORT=${PLAYLIZT_CONTENT_API_PORT}
      - SPRING_DATASOURCE_URL=jdbc:postgresql://${PLAYLIZT_DB_HOST}:${PLAYLIZT_DB_PORT}/${PLAYLIZT_DB_NAME}
      - SPRING_DATASOURCE_USERNAME=${PLAYLIZT_DB_USER}
      - SPRING_DATASOURCE_PASSWORD=${PLAYLIZT_DB_PASSWORD}
      - SPRING_CLOUD_GCP_SQL_ENABLED=${SPRING_CLOUD_GCP_SQL_ENABLED}
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=${PLAYLIZT_EUREKA_URL}
      - GEMINI_API_KEY=${PLAYLIZT_GEMINI_API_KEY}
      - JAVA_OPTS=${JAVA_OPTS}
      - TZ=${TZ}
    ports:
      - "${PLAYLIZT_CONTENT_API_PORT}:${PLAYLIZT_CONTENT_API_PORT}"
    volumes:
      - ${PLAYLIZT_LOG_PATH}/content:/var/log/playlizt
      - uploads_data:/uploads
    networks:
      - playlizt-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${PLAYLIZT_CONTENT_API_PORT}/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    depends_on:
      playlizt-database:
        condition: service_healthy
      playlizt-eureka-service:
        condition: service_healthy

  # =============================================================================
  # PLAYBACK SERVICE
  # =============================================================================
  playlizt-playback:
    build:
      context: .
      dockerfile: playlizt-playback/Dockerfile
      args:
        PLAYLIZT_UID: ${PLAYLIZT_UID}
        PLAYLIZT_GID: ${PLAYLIZT_GID}
        SERVER_PORT: ${PLAYLIZT_PLAYBACK_PORT}
    container_name: playlizt-playback
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE}
      - SERVER_PORT=${PLAYLIZT_PLAYBACK_PORT}
      - SPRING_DATASOURCE_URL=jdbc:postgresql://${PLAYLIZT_DB_HOST}:${PLAYLIZT_DB_PORT}/${PLAYLIZT_DB_NAME}
      - SPRING_DATASOURCE_USERNAME=${PLAYLIZT_DB_USER}
      - SPRING_DATASOURCE_PASSWORD=${PLAYLIZT_DB_PASSWORD}
      - SPRING_CLOUD_GCP_SQL_ENABLED=${SPRING_CLOUD_GCP_SQL_ENABLED}
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=${PLAYLIZT_EUREKA_URL}
      - JAVA_OPTS=${JAVA_OPTS}
      - TZ=${TZ}
    ports:
      - "${PLAYLIZT_PLAYBACK_PORT}:${PLAYLIZT_PLAYBACK_PORT}"
    volumes:
      - ${PLAYLIZT_LOG_PATH}/playback:/var/log/playlizt
    networks:
      - playlizt-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${PLAYLIZT_PLAYBACK_PORT}/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    depends_on:
      playlizt-database:
        condition: service_healthy
      playlizt-eureka-service:
        condition: service_healthy

  # =============================================================================
  # AI SERVICE
  # =============================================================================
  playlizt-content-processing:
    build:
      context: .
      dockerfile: playlizt-content/playlizt-content-processing/Dockerfile
      args:
        PLAYLIZT_UID: ${PLAYLIZT_UID}
        PLAYLIZT_GID: ${PLAYLIZT_GID}
        SERVER_PORT: ${PLAYLIZT_CONTENT_PROCESSING_PORT}
    container_name: playlizt-content-processing
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE}
      - SERVER_PORT=${PLAYLIZT_CONTENT_PROCESSING_PORT}
      - SPRING_DATASOURCE_URL=jdbc:postgresql://${PLAYLIZT_DB_HOST}:${PLAYLIZT_DB_PORT}/${PLAYLIZT_DB_NAME}
      - SPRING_DATASOURCE_USERNAME=${PLAYLIZT_DB_USER}
      - SPRING_DATASOURCE_PASSWORD=${PLAYLIZT_DB_PASSWORD}
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=${PLAYLIZT_EUREKA_URL}
      - GEMINI_API_KEY=${PLAYLIZT_GEMINI_API_KEY}
      - GEMINI_MODEL=${PLAYLIZT_GEMINI_MODEL}
      - GEMINI_FALLBACK_MODELS=${PLAYLIZT_GEMINI_FALLBACK_MODELS}
      - GEMINI_MAX_TOKENS=${PLAYLIZT_GEMINI_MAX_TOKENS}
      - GEMINI_TEMPERATURE=${PLAYLIZT_GEMINI_TEMPERATURE}
      - GEMINI_RATE_LIMIT_RPM=${PLAYLIZT_GEMINI_RATE_LIMIT_RPM}
      - JAVA_OPTS=${JAVA_OPTS}
      - TZ=${TZ}
    ports:
      - "${PLAYLIZT_CONTENT_PROCESSING_PORT}:${PLAYLIZT_CONTENT_PROCESSING_PORT}"
    volumes:
      - ${PLAYLIZT_LOG_PATH}/ai:/var/log/playlizt
    networks:
      - playlizt-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${PLAYLIZT_CONTENT_PROCESSING_PORT}/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    depends_on:
      playlizt-database:
        condition: service_healthy
      playlizt-eureka-service:
        condition: service_healthy

  # =============================================================================
  # API GATEWAY
  # =============================================================================
  playlizt-api-gateway:
    build:
      context: .
      dockerfile: playlizt-api-gateway/Dockerfile
      args:
        PLAYLIZT_UID: ${PLAYLIZT_UID}
        PLAYLIZT_GID: ${PLAYLIZT_GID}
        SERVER_PORT: ${PLAYLIZT_API_GATEWAY_PORT}
    container_name: playlizt-api-gateway
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE}
      - SERVER_PORT=${PLAYLIZT_API_GATEWAY_PORT}
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=${PLAYLIZT_EUREKA_URL}
      - AUTH_SERVICE_URL=http://playlizt-authentication:${PLAYLIZT_AUTH_PORT}
      - CONTENT_SERVICE_URL=http://playlizt-content-api:${PLAYLIZT_CONTENT_API_PORT}
      - PLAYBACK_SERVICE_URL=http://playlizt-playback:${PLAYLIZT_PLAYBACK_PORT}
      - AI_SERVICE_URL=http://playlizt-content-processing:${PLAYLIZT_CONTENT_PROCESSING_PORT}
      - JAVA_OPTS=${JAVA_OPTS}
      - TZ=${TZ}
    ports:
      - "${PLAYLIZT_API_GATEWAY_PORT}:${PLAYLIZT_API_GATEWAY_PORT}"
    volumes:
      - ${PLAYLIZT_LOG_PATH}/gateway:/var/log/playlizt
    networks:
      - playlizt-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${PLAYLIZT_API_GATEWAY_PORT}/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    depends_on:
      playlizt-eureka-service:
        condition: service_healthy
      playlizt-authentication:
        condition: service_healthy
      playlizt-content-api:
        condition: service_healthy
      playlizt-playback:
        condition: service_healthy
      playlizt-content-processing:
        condition: service_healthy

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  playlizt-network:
    driver: bridge

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  postgres_data:
    driver: local
  uploads_data:
    driver: local
